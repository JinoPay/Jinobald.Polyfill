name: Build and Test

on:
  push:
    branches: [ main, develop, 'JinoPay/**' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: 1

jobs:
  # 빌드 매트릭스: 모든 타겟 프레임워크 검증
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # GitVersion을 위해 전체 히스토리 필요

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: |
          6.0.x
          8.0.x
          9.0.x

    # .NET Framework는 Windows에서만 빌드 가능
    - name: Setup MSBuild (Windows only)
      if: runner.os == 'Windows'
      uses: microsoft/setup-msbuild@v2

    - name: Restore dependencies
      run: dotnet restore

    - name: Build solution
      run: dotnet build --configuration Release --no-restore

    - name: Build specific frameworks (Windows only)
      if: runner.os == 'Windows'
      continue-on-error: true
      shell: pwsh
      run: |
        # .NET Framework 타겟들은 Windows에서만 빌드
        $frameworks = @(
          'net35', 'net40', 'net45', 'net451', 'net452',
          'net46', 'net461', 'net462', 'net47', 'net471',
          'net472', 'net48', 'net481'
        )

        foreach ($fw in $frameworks) {
          Write-Host "Building for $fw..."
          try {
            dotnet build src/Jinobald.Polyfill/Jinobald.Polyfill.csproj `
              --framework $fw `
              --configuration Release `
              --no-restore
          } catch {
            Write-Warning "Failed to build $fw (may not be installed)"
          }
        }

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ matrix.os }}
        path: |
          src/Jinobald.Polyfill/bin/Release/
          !**/*.pdb
        retention-days: 7

  # 테스트 실행 (프레임워크별)
  test:
    name: Test .NET ${{ matrix.framework }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: build
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        framework:
          - net6.0
          - net8.0
          - net9.0
        include:
          # .NET Framework는 Windows에서만 (테스트 프로젝트가 지원하는 버전만)
          - os: windows-latest
            framework: net462
          - os: windows-latest
            framework: net48
          - os: windows-latest
            framework: net481

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: |
          6.0.x
          8.0.x
          9.0.x

    - name: Restore dependencies
      run: dotnet restore

    - name: Run tests for ${{ matrix.framework }}
      continue-on-error: true
      run: |
        dotnet test tests/Jinobald.Polyfill.Tests/Jinobald.Polyfill.Tests.csproj \
          --framework ${{ matrix.framework }} \
          --configuration Release \
          --no-restore \
          --verbosity normal \
          --logger "trx;LogFileName=test-results-${{ matrix.framework }}.trx" \
          --collect:"XPlat Code Coverage" \
          -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.framework }}-${{ matrix.os }}
        path: |
          **/TestResults/*.trx
          **/TestResults/**/coverage.opencover.xml
        retention-days: 30

  # 코드 커버리지 리포트
  coverage:
    name: Code Coverage Report
    runs-on: ubuntu-latest
    needs: test
    if: always() && needs.test.result != 'cancelled'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all test results
      uses: actions/download-artifact@v4
      with:
        path: test-results
        pattern: test-results-*

    - name: Install ReportGenerator
      run: dotnet tool install -g dotnet-reportgenerator-globaltool

    - name: Generate coverage report
      continue-on-error: true
      run: |
        if [ -d "test-results" ] && find test-results -name "coverage.opencover.xml" | grep -q .; then
          reportgenerator \
            -reports:"test-results/**/coverage.opencover.xml" \
            -targetdir:"coverage-report" \
            -reporttypes:"Html;Cobertura;MarkdownSummaryGithub" \
            -verbosity:Info
        else
          echo "No coverage files found, skipping report generation"
          mkdir -p coverage-report
          echo "# No Test Coverage\nNo tests were run yet." > coverage-report/SummaryGithub.md
        fi

    - name: Add coverage to PR comment
      uses: marocchino/sticky-pull-request-comment@v2
      if: github.event_name == 'pull_request'
      with:
        path: coverage-report/SummaryGithub.md

    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage-report/
        retention-days: 30

    - name: Publish coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: coverage-report/Cobertura.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  # NuGet 패키징 (릴리스용)
  package:
    name: Create NuGet Package
    runs-on: windows-latest
    needs: [build, test]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v1
      with:
        versionSpec: '5.x'

    - name: Determine Version
      id: gitversion
      uses: gittools/actions/gitversion/execute@v1
      with:
        useConfigFile: true
        configFilePath: GitVersion.yml

    - name: Display version
      run: |
        echo "Version: ${{ steps.gitversion.outputs.semVer }}"
        echo "NuGet Version: ${{ steps.gitversion.outputs.nuGetVersionV2 }}"

    - name: Restore dependencies
      run: dotnet restore

    - name: Build for packaging
      run: |
        dotnet build src/Jinobald.Polyfill/Jinobald.Polyfill.csproj `
          --configuration Release `
          --no-restore `
          /p:Version=${{ steps.gitversion.outputs.nuGetVersionV2 }} `
          /p:AssemblyVersion=${{ steps.gitversion.outputs.assemblySemVer }} `
          /p:FileVersion=${{ steps.gitversion.outputs.assemblySemFileVer }} `
          /p:InformationalVersion=${{ steps.gitversion.outputs.informationalVersion }}

    - name: Pack NuGet package
      run: |
        dotnet pack src/Jinobald.Polyfill/Jinobald.Polyfill.csproj `
          --configuration Release `
          --no-build `
          --output nupkg `
          /p:PackageVersion=${{ steps.gitversion.outputs.nuGetVersionV2 }} `
          /p:IncludeSymbols=true `
          /p:SymbolPackageFormat=snupkg

    - name: Upload NuGet package
      uses: actions/upload-artifact@v4
      with:
        name: nuget-package
        path: nupkg/*.nupkg
        retention-days: 90

    - name: Upload symbol package
      uses: actions/upload-artifact@v4
      with:
        name: symbol-package
        path: nupkg/*.snupkg
        retention-days: 90

  # 코드 품질 분석
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --configuration Release --no-restore

    - name: Run Roslynator analyzers
      continue-on-error: true
      run: |
        dotnet tool install -g Roslynator.DotNet.Cli
        roslynator analyze --report-not-configurable --report-suppressed-diagnostics || echo "Roslynator analysis completed with warnings"

    - name: SonarCloud Scan
      continue-on-error: true
      if: (github.event_name == 'pull_request' || github.ref == 'refs/heads/main') && env.SONAR_TOKEN != ''
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.projectKey=Jinobald_Polyfill
          -Dsonar.organization=jinobald
          -Dsonar.cs.opencover.reportsPaths=**/coverage.opencover.xml
          -Dsonar.coverage.exclusions=**Tests**
