name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: '릴리스 버전 (예: 2.0.0)'
        required: true
        type: string

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  DOTNET_NOLOGO: true

jobs:
  # ===========================================
  # 릴리스 빌드 및 테스트
  # ===========================================
  release-build:
    name: Release Build
    runs-on: windows-latest

    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if ("${{ github.event.inputs.version }}" -ne "") {
            $version = "${{ github.event.inputs.version }}"
          } else {
            $version = "${{ github.ref_name }}".TrimStart('v')
          }
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "Version: $version"
        shell: pwsh

      - name: Setup .NET SDKs
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            6.0.x
            7.0.x
            8.0.x
            9.0.x
            10.0.x

      - name: Restore
        run: dotnet restore Jinobald.Polyfill.sln

      - name: Build Release
        run: |
          dotnet build Jinobald.Polyfill.sln -c Release --no-restore `
            /p:Version=${{ steps.version.outputs.version }} `
            /p:AssemblyVersion=${{ steps.version.outputs.version }} `
            /p:FileVersion=${{ steps.version.outputs.version }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-build
          path: |
            src/*/bin/Release/
          retention-days: 30

  # ===========================================
  # 전체 테스트 (릴리스 전 검증)
  # ===========================================
  release-test:
    name: Release Test
    needs: release-build
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        framework:
          - net462
          - net472
          - net481
          - net6.0
          - net8.0
          - net9.0
          - net10.0

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET SDKs
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            6.0.x
            7.0.x
            8.0.x
            9.0.x
            10.0.x

      - name: Restore
        run: dotnet restore Jinobald.Polyfill.sln

      - name: Build
        run: dotnet build Jinobald.Polyfill.sln -c Release --no-restore

      - name: Test ${{ matrix.framework }}
        run: |
          dotnet test tests/Jinobald.Polyfill.Tests/Jinobald.Polyfill.Tests.csproj `
            --framework ${{ matrix.framework }} `
            -c Release `
            --no-build `
            --verbosity normal

  # ===========================================
  # NuGet 패키지 생성
  # ===========================================
  package:
    name: Create Package
    needs: [release-build, release-test]
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore
        run: dotnet restore Jinobald.Polyfill.sln

      - name: Pack
        run: |
          dotnet pack src/Jinobald.Polyfill/Jinobald.Polyfill.csproj `
            -c Release `
            --no-restore `
            /p:PackageVersion=${{ needs.release-build.outputs.version }} `
            /p:Version=${{ needs.release-build.outputs.version }} `
            -o ./packages

      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages
          path: ./packages/*.nupkg
          retention-days: 30

  # ===========================================
  # NuGet.org 퍼블리시
  # ===========================================
  publish-nuget:
    name: Publish to NuGet.org
    needs: [release-build, package]
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Download packages
        uses: actions/download-artifact@v4
        with:
          name: nuget-packages
          path: ./packages

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Publish to NuGet.org
        run: |
          dotnet nuget push ./packages/*.nupkg \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}

  # ===========================================
  # GitHub Release 생성
  # ===========================================
  github-release:
    name: Create GitHub Release
    needs: [release-build, package, publish-nuget]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download packages
        uses: actions/download-artifact@v4
        with:
          name: nuget-packages
          path: ./packages

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.release-build.outputs.version }}
          name: Release v${{ needs.release-build.outputs.version }}
          body: |
            ## Jinobald.Polyfill v${{ needs.release-build.outputs.version }}

            ### 지원 프레임워크
            - .NET Framework: 3.5, 4.0, 4.5, 4.5.1, 4.5.2, 4.6, 4.6.1, 4.6.2, 4.7, 4.7.1, 4.7.2, 4.8, 4.8.1
            - .NET: 6.0, 7.0, 8.0, 9.0, 10.0

            ### 설치
            ```bash
            dotnet add package Jinobald.Polyfill --version ${{ needs.release-build.outputs.version }}
            ```

            ### 변경 사항
            자세한 내용은 [CHANGELOG.md](CHANGELOG.md)를 참조하세요.
          files: |
            ./packages/*.nupkg
          draft: false
          prerelease: ${{ contains(needs.release-build.outputs.version, '-') }}
